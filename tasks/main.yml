---

- name: Update apt cache.
  apt: update_cache=yes cache_valid_time=86400

- name: Ensure zephir required packages are installed.
  apt:
    name: "{{ item }}"
    state: "installed"
  with_items: "{{ php7_phalcon_zephir_required_packages }}"

- name: Install zephir
  shell: composer global require "phalcon/zephir:dev-master" -vv

- name: Git clone cphalcon {{php7_phalcon_cphalcon_version}}
  git:
    repo: "https://github.com/phalcon/cphalcon.git"
    version: "{{ php7_phalcon_cphalcon_version }}"
    depth: 1
    dest: "/opt/cphalcon_{{ php7_phalcon_cphalcon_version }}"
    force: yes

- name: Build cphalcon
  shell: ~/.composer/vendor/bin/zephir build --backend=ZendEngine3
  args:
    chdir: "/opt/cphalcon_{{ php7_phalcon_cphalcon_version }}"
    warn: false

- name: Ensure cli phalcon extension ini file exists
  file:
    path: "{{ php7_phalcon_cli_phalcon_ini }}"
    state: touch
  when: "{{ php7_phalcon_enable_cli_ini }}"

- name: Enable phalcon extension for cli ini
  lineinfile:
    dest: "{{ php7_phalcon_cli_phalcon_ini }}"
    line: 'extension=phalcon.so'
  when: "{{ php7_phalcon_enable_cli_ini }}"

- name: Ensure fpm phalcon extension ini file exists
  file:
    path: "{{ php7_phalcon_fpm_phalcon_ini }}"
    state: touch
  when: "{{ php7_phalcon_enable_fpm_ini }}"

- name: Enable phalcon extension for fpm ini
  lineinfile:
    dest: "{{ php7_phalcon_fpm_phalcon_ini }}"
    line: 'extension=phalcon.so'
  when: "{{ php7_phalcon_enable_fpm_ini }}"

- name: Install phalcon dev tool
  shell: composer global require "phalcon/devtools:{{ php7_phalcon_devtools_version }}" -vv
  when: "{{ php7_phalcon_install_devtools }}"

- name: Make link /usr/bin/phalcon
  file:
    src: "~/.composer/vendor/phalcon/devtools/phalcon.php"
    dest: "/usr/bin/phalcon"
    state: link
    force: yes
  when: "{{ php7_phalcon_install_devtools }}"
